!function(a){"use strict";window.namespace=function(b,c){for(var d,e=window,f=b.split(".");d=f.shift();)e[d]=e[d]||{},e=e[d];a.extend(e,c)}}(window._),function(){namespace("Notification"),Notification.Controller=function(){function a(){}return a.settings={},a.setupWidgetIn=function(a){return new Notification.Widgets.Controller(a).initialize(),this.settings=a},a.exitEditMode=function(){return $("[data-id=notification-widget-wrapper] [data-id=notification-form]").hide(this.animationSpeed()),$("[data-id=notification-widget-wrapper] .widget-close").hide(this.animationSpeed())},a.enterEditMode=function(){return $("[data-id=notification-widget-wrapper] [data-id=notification-form]").show(this.animationSpeed()),$("[data-id=notification-widget-wrapper] .widget-close").show(this.animationSpeed())},a.animationSpeed=function(){return this.settings.animationSpeed},a}()}.call(this),function(){namespace("Notification"),Notification.Display=function(){function a(){}return a.generateLogo=function(a){return'<i class="fa fa-bell '+a["class"]+'" data-id="'+a.dataId+'"></i>'},a}()}.call(this),function(){namespace("Notification.Widgets"),Notification.Widgets.API=function(){function a(){}return a.getEmailsFrom=function(a,b){return $.get("/emails?from="+(b||"*@8thlight.com"),function(b){return a.processEmails(b)})},a.getEmail=function(a,b){return $.get("/emails/"+a,function(a){return b.processEmail(a)})},a}()}.call(this),function(){namespace("Notification.Widgets"),Notification.Widgets.Controller=function(){function a(a){this.container=a.container,this.refreshRate=a.refreshRate,this.defaultValue=a.defaultValue,this.isActive=!1,this.display=new Notification.Widgets.Display(a),this.processor=new Notification.Widgets.EmailProcessor(this.display,a.maxNotifications)}return a.prototype.initialize=function(){return this.display.setup(),this.bind(),this.activate(),this.displayDefault()},a.prototype.bind=function(){return $(""+this.container+" [data-id=notification-button]").on("click",function(a){return function(){return a.getNotifications(a.display.getInput())}}(this)),$(""+this.container+" [data-id=notification-close]").on("click",function(a){return function(){return a.closeWidget()}}(this))},a.prototype.unbind=function(){return $(""+this.container+" [data-id=notification-button]").unbind("click"),$(""+this.container+" [data-id=notification-close]").unbind("click")},a.prototype.activate=function(){return this.isActive=!0},a.prototype.deactivate=function(){return this.isActive=!1},a.prototype.displayDefault=function(){return this.defaultValue?this.getNotifications(this.defaultValue):void 0},a.prototype.getNotifications=function(a){return this.processor.getNotifications(a),this.refreshRate?this.refreshNotifications(a):void 0},a.prototype.refreshNotifications=function(a){return this.clearCurrentTimeout(),this.timeout=setTimeout(function(b){return function(){return b.isActive?b.getNotifications(a):void 0}}(this),this.refreshSeconds())},a.prototype.clearCurrentTimeout=function(){return this.timeout?clearTimeout(this.timeout):void 0},a.prototype.closeWidget=function(){return $(this.container).remove(),this.deactivate(),this.unbind()},a.prototype.refreshSeconds=function(){return 1e3*this.refreshRate},a}()}.call(this),function(){namespace("Notification.Widgets"),Notification.Widgets.Display=function(){function a(a){this.container=a.container}return a.prototype.setup=function(){var a;return a=Notification.Widgets.Templates.renderForm(),$(this.container).html(a)},a.prototype.getInput=function(){return $(""+this.container+" [name=notification-search]").val()},a.prototype.renderEmails=function(a){var b;return b=Notification.Widgets.Templates.renderEmails(a),$(""+this.container+" [data-id=notification-output]").html(b)},a}()}.call(this),function(){namespace("Notification.Widgets"),Notification.Widgets.EmailPresenter=function(){function a(a){this.id=a.id,this.from=a.from,this.subject=a.subject,this.symbol=this.generateSymbol(a.subject),this.body=this.generateBody(a.subject)}return a.prototype.generateSymbol=function(a){return this.contains(a,"[alert]")?'<i class="red fa fa-exclamation-circle"></i>':'<i class="fa fa-bell"></i>'},a.prototype.contains=function(a,b){return-1!==a.indexOf(b)},a.prototype.generateBody=function(a){var b;return b=a.split("] ")[1],this.sanitizeBody(b)},a.prototype.sanitizeBody=function(a){return _.each(this.charactersToEscape,function(){return function(b,c){var d;for(d=[];-1!==a.indexOf(c);)d.push(a=a.replace(c,b));return d}}(this)),a},a.prototype.charactersToEscape={"<":"&lt;",">":"&gt;",'"':"&quot;"},a}()}.call(this),function(){namespace("Notification.Widgets"),Notification.Widgets.EmailProcessor=function(){function a(a,b){this.display=a,this.maxNotifications=b,this.currentNotifications=[],this.notificationsHistory=[]}return a.prototype.getNotifications=function(a){return Notification.Widgets.API.getEmailsFrom(this,a)},a.prototype.processEmails=function(a){return _.each(a.reverse(),function(a){return function(b){return a.isNewEmail(b)?a.getNewEmail(b):void 0}}(this))},a.prototype.isNewEmail=function(a){var b;return b=!0,_.each(this.notificationsHistory,function(c){return c.id===a.id?b=!1:void 0}),b},a.prototype.getNewEmail=function(a){return Notification.Widgets.API.getEmail(a.id,this)},a.prototype.processEmail=function(a){return this.addToHistory(a),this.hasValidSubject(a)?this.displayEmail(a):void 0},a.prototype.hasValidSubject=function(a){return a.subject&&this.containsNotificationType(a.subject)},a.prototype.containsNotificationType=function(a){return this.contains(a,"[alert] ")||this.contains(a,"[notification] ")},a.prototype.contains=function(a,b){return-1!==a.indexOf(b)},a.prototype.displayEmail=function(a){return this.addToCurrentNotifications(a),this.display.renderEmails(this.recentEmails())},a.prototype.addToHistory=function(a){return this.addToBegining(this.notificationsHistory,a)},a.prototype.addToCurrentNotifications=function(a){return this.addToBegining(this.currentNotifications,this.createPresenter(a))},a.prototype.createPresenter=function(a){return new Notification.Widgets.EmailPresenter(a)},a.prototype.addToBegining=function(a,b){return a.unshift(b)},a.prototype.recentEmails=function(){return this.currentNotifications.slice(0,this.maxNotifications)},a}()}.call(this),function(){namespace("Notification.Widgets"),Notification.Widgets.Templates=function(){function a(){}return a.renderForm=function(){return _.template('<div class="widget" data-id="notification-widget-wrapper">\n  <div class="widget-header">\n    <h2 class="widget-title">Notifications</h2>\n    <span class=\'widget-close\' data-id=\'notification-close\'>Ã—</span>\n    <div class="widget-form" data-id="notification-form">\n      <input name="notification-search" type="text" autofocus="true">\n      <button data-id="notification-button">Load Notifications</button><br>\n    </div>\n  </div>\n  <div class="widget-body" data-id="notification-output"></div>\n</div>',{})},a.renderEmails=function(a){return _.template('<% emails.forEach(function(email) { %>\n  <div class="notification">\n    <div class="notification-symbol">\n      <%= email.symbol %>\n    </div>\n    <div class="notification-content">\n      <div class="notification-author">\n        <%= email.from %>\n      </div>\n      <div class="notification-body">\n        <%= email.body %>\n      </div>\n    </div>\n  </div>\n<% }) %>\n',{emails:a})},a}()}.call(this);